import asyncio
import os
import easyocr  # –°–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –Ω–µ–π—Ä–æ—Å–µ—Ç—å –¥–ª—è OCR
from aiogram import Bot, Dispatcher, types, F
from aiogram.filters import Command

TOKEN = "–í–ê–®_–¢–û–ö–ï–ù"
bot = Bot(token=TOKEN)
dp = Dispatcher()

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –Ω–µ–π—Ä–æ—Å–µ—Ç—å (—Ä—É—Å—Å–∫–∏–π + –∞–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫–∏)
reader = easyocr.Reader(['ru', 'en'])

FRAUD_KEYWORDS = ["–±–µ–∑–æ–ø–∞—Å–Ω—ã–π —Å—á–µ—Ç", "–∫–æ–¥ –∏–∑ —Å–º—Å", "—Å—Ä–æ—á–Ω–æ –ø–µ—Ä–µ–≤–µ–¥–∏—Ç–µ", "–≤—ã–∏–≥—Ä—ã—à"]

async def analyze_fraud(text: str) -> str:
    found = [word for word in FRAUD_KEYWORDS if word in text.lower()]
    if found:
        return f"üö® –û–ü–ê–°–ù–û! –ù–∞–π–¥–µ–Ω—ã —Ñ—Ä–∞–∑—ã –º–æ—à–µ–Ω–Ω–∏–∫–æ–≤: {', '.join(found)}"
    return "‚úÖ –¢–µ–∫—Å—Ç –Ω–∞ —Å–∫—Ä–∏–Ω—à–æ—Ç–µ –≤—ã–≥–ª—è–¥–∏—Ç —á–∏—Å—Ç—ã–º."

@dp.message(F.photo)
async def handle_screenshot(message: types.Message):
    # –£–≤–µ–¥–æ–º–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —á—Ç–æ –Ω–µ–π—Ä–æ—Å–µ—Ç—å –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—É
    status_msg = await message.reply("ü§ñ –ù–µ–π—Ä–æ—Å–µ—Ç—å –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Å–∫—Ä–∏–Ω—à–æ—Ç...")
    
    # –°–∫–∞—á–∏–≤–∞–µ–º —Ñ–æ—Ç–æ –≤–æ –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
    photo = message.photo[-1]
    file_info = await bot.get_file(photo.file_id)
    photo_path = f"temp_{photo.file_id}.jpg"
    await bot.download_file(file_info.file_path, photo_path)

    try:
        # –†–∞—Å–ø–æ–∑–Ω–∞–µ–º —Ç–µ–∫—Å—Ç —Å –ø–æ–º–æ—â—å—é EasyOCR
        result = reader.readtext(photo_path, detail=0)
        extracted_text = " ".join(result)
        
        if not extracted_text.strip():
            await status_msg.edit_text("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å—á–∏—Ç–∞—Ç—å —Ç–µ–∫—Å—Ç —Å–æ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞.")
        else:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—Å—Ç –Ω–∞ –º–æ—à–µ–Ω–Ω–∏—á–µ—Å—Ç–≤–æ
            analysis_result = await analyze_fraud(extracted_text)
            await status_msg.edit_text(f"üîç **–†–µ–∑—É–ª—å—Ç–∞—Ç —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è:**\n\n{analysis_result}")
            
    finally:
        if os.path.exists(photo_path):
            os.remove(photo_path)

@dp.message(Command("start"))
async def start(message: types.Message):
    await message.answer("–ü—Ä–∏—à–ª–∏—Ç–µ —Å–∫—Ä–∏–Ω—à–æ—Ç –ø–µ—Ä–µ–ø–∏—Å–∫–∏, –∏ —è –ø—Ä–æ–≤–µ—Ä—é –µ–≥–æ –Ω–∞ –ø—Ä–∏–∑–Ω–∞–∫–∏ –º–æ—à–µ–Ω–Ω–∏—á–µ—Å—Ç–≤–∞!")

async def main():
    await dp.start_polling(bot)

if __name__ == "__main__":
    asyncio.run(main())
